<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Sysware Cheat Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #0a0a1a;
      color: #e0e0ff;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div class="max-w-md w-full mx-4 p-6 bg-gray-800 rounded-lg border border-green-400">
    <h1 class="text-2xl font-bold text-green-400 mb-6 text-center">Reset Your Password</h1>
    
    <div class="mb-4 p-3 bg-yellow-900 border border-yellow-600 rounded-lg">
      <p class="text-yellow-200 text-sm">
        ⚠️ <strong>ATTENTION:</strong> If you didn't receive the reset email, please check your Gmail spam folder!
      </p>
    </div>
    
    <div id="loading" class="text-center">
      <p>Processing reset request...</p>
    </div>
    
    <div id="reset-form" class="hidden">
      <input
        type="password"
        id="new-password"
        placeholder="Enter new password"
        class="w-full p-3 mb-4 bg-gray-900 text-white rounded-lg border border-green-400 focus:outline-none focus:ring-2 focus:ring-green-400"
      />
      <input
        type="password"
        id="confirm-password"
        placeholder="Confirm new password"
        class="w-full p-3 mb-4 bg-gray-900 text-white rounded-lg border border-green-400 focus:outline-none focus:ring-2 focus:ring-green-400"
      />
      <button
        id="update-password"
        class="w-full p-3 bg-green-400 text-black rounded-lg font-semibold hover:bg-green-500 transition-colors"
      >
        Update Password
      </button>
    </div>
    
    <div id="message" class="mt-4 text-center hidden"></div>
  </div>

  <script>
    const supabaseUrl = 'https://dlzpktmtxcbknpulwnzp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsenBrdG10eGNia25wdWx3bnpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNzgyNjEsImV4cCI6MjA2OTc1NDI2MX0.0paajBHMgqsZHEfufMglEtyqGMDaJBDx2YBfvsR2p-M';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const loadingDiv = document.getElementById('loading');
    const resetForm = document.getElementById('reset-form');
    const messageDiv = document.getElementById('message');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const updateButton = document.getElementById('update-password');

    function showMessage(text, isError = false) {
      messageDiv.textContent = text;
      messageDiv.className = `mt-4 text-center ${isError ? 'text-red-400' : 'text-green-400'}`;
      messageDiv.classList.remove('hidden');
    }

    // Check if user is authenticated (came from reset email)
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY') {
        loadingDiv.classList.add('hidden');
        resetForm.classList.remove('hidden');
      } else if (event === 'SIGNED_IN' && session) {
        // Password was successfully updated
        showMessage('Password updated successfully! Redirecting to store...');
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      }
    });

    updateButton.addEventListener('click', async () => {
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (!newPassword || !confirmPassword) {
        showMessage('Please fill in both password fields.', true);
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage('Passwords do not match.', true);
        return;
      }

      if (newPassword.length < 6) {
        showMessage('Password must be at least 6 characters long.', true);
        return;
      }

      try {
        updateButton.disabled = true;
        updateButton.textContent = 'Updating...';

        const { error } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (error) throw error;

        showMessage('Password updated successfully! Redirecting...');
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);

      } catch (error) {
        showMessage('Error updating password: ' + error.message, true);
        updateButton.disabled = false;
        updateButton.textContent = 'Update Password';
      }
    });

    // If no session after 3 seconds, show error
    setTimeout(() => {
      if (loadingDiv && !loadingDiv.classList.contains('hidden')) {
        loadingDiv.classList.add('hidden');
        showMessage('Invalid or expired reset link. Please request a new password reset.', true);
      }
    }, 3000);
  </script>
</body>
</html>