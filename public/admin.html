<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link href="/dist/assets/index.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-background text-text font-inter">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-primary mb-8">Admin Panel</h1>
    <div id="orders" class="space-y-4"></div>
    <div id="error" class="text-red-500 mt-4"></div>
  </div>
  <script>
    const supabaseUrl = 'https://dlzpktmtxcbknpulwnzp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsenBrdG10eGNia25wdWx3bnpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNzgyNjEsImV4cCI6MjA2OTc1NDI2MX0.0paajBHMgqsZHEfufMglEtyqGMDaJBDx2YBfvsR2p-M';
    const supabase = Supabase.createClient(supabaseUrl, supabaseKey);
    const ADMIN_TOKEN = 'YOUR_ADMIN_TOKEN'; // Replace with JWT from approve-order function
    const errorDiv = document.getElementById('error');

    async function loadOrders() {
      try {
        const { data, error } = await supabase
          .from('orders')
          .select('*, users(firebase_uid)')
          .eq('status', 'pending');
        if (error) throw error;
        const ordersDiv = document.getElementById('orders');
        ordersDiv.innerHTML = "<h2 class='text-xl mb-2'>Pending Orders</h2>";
        if (data.length === 0) {
          ordersDiv.innerHTML += "<p>No pending orders.</p>";
          return;
        }
        data.forEach(order => {
          const div = document.createElement('div');
          div.className = 'p-4 bg-card rounded-lg border border-primary';
          div.innerHTML = `
            <p>Order ID: ${order.id}</p>
            <p>User: ${order.users.firebase_uid}</p>
            <p>Items: ${order.items.map(item => item.name).join(', ')}</p>
            <button onclick="approveOrder(${order.id})" class="px-4 py-2 bg-primary text-background rounded-lg pulse-glow">Approve</button>
          `;
          ordersDiv.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('orders').innerHTML = `<p class="text-red-500">Error loading orders: ${error.message}</p>`;
      }
    }

    async function approveOrder(orderId) {
      try {
        console.log('Approving order ID:', orderId); // Debug log
        const response = await fetch('https://dlzpktmtxcbknpulwnzp.supabase.co/functions/v1/approve-order', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ADMIN_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_id: orderId })
        });
        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || `HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        console.log('Approval response:', result); // Debug log
        alert('Order approved!');
        loadOrders();
      } catch (error) {
        console.error('Approval error:', error);
        errorDiv.textContent = `Error approving order: ${error.message}`;
      }
    }

    loadOrders();
  </script>
</body>
</html>